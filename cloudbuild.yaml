steps:
  - name: maven:3-jdk-11
    entrypoint: mvn
    args: ["test"]

  - name: maven:3-jdk-11
    entrypoint: mvn
    args: ["package", "-Dmaven.test.skip=true"]

  #    sonarcube
  - name: "gcr.io/kwetter-313614/sonar-scanner"
    args:
      - "-Dsonar.host.url=https://sonarcloud.io"
      - "-Dsonar.login=8609b8f321c6cccc4fa7b22c32014271676c9dde"
      - "-Dsonar.projectKey=kwetter-kweetservice"
      - "-Dsonar.organization=miltonvandesanden"
#      - "-Dsonar.scm.provider=git"
      - "-Dsonar.scm.disabled=false"
      - "-Dsonar.language=java"
      - "-Dsonar.sources=src/main/java"
      - "-Dsonar.tests=src/test/java"
      - "-Dsonar.java.binaries=./target/classes"
#      - "-Dsonar.verbose=true"

  - name: gcr.io/cloud-builders/docker
    args: ["build", "-t", "eu.gcr.io/kwetter-313614/kweetservice", "--build-arg=JAR_FILE=target/kweetservice-0.0.1-SNAPSHOT.jar", "."]

  - name: "gcr.io/cloud-builders/gke-deploy"
    args:
      - run
      - --filename=deployment.yaml
      - --location=europe-west4
      - --cluster=kwetter-cluster

  - name: "gcr.io/cloud-builders/kubectl"
    args:
      - rollout
      - restart
      - deployment
      - kweetservice
    env:
      - "CLOUDSDK_COMPUTE_ZONE=${_COMPUTE_ZONE}"
      - "CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}"

substitutions:
  _CLUSTER_NAME: kwetter-cluster
  _COMPUTE_ZONE: europe-west4

images: ["eu.gcr.io/kwetter-313614/kweetservice"]
tags: ["cloud-builders-community"]